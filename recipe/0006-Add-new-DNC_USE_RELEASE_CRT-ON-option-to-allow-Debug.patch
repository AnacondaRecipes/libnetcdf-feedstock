From 5f72b0abe6f9eaae2013eaf3024c0b13ff8f56b2 Mon Sep 17 00:00:00 2001
From: Ray Donnelly <mingw.android@gmail.com>
Date: Sat, 12 May 2018 10:09:22 -0500
Subject: [PATCH 6/6] Add new -DNC_USE_RELEASE_CRT=ON option to allow Debug
 builds with non-Debug CRT (msvc*90.dll)

---
 CMakeLists.txt | 25 +++++++++++++++++++++----
 1 file changed, 21 insertions(+), 4 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 93e2806a..47308b85 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -332,7 +332,8 @@ ENDIF(${CMAKE_SYSTEM_NAME} EQUAL "Darwin")
 # Taken From:
 #   http://www.cmake.org/Wiki/CMake_FAQ#How_can_I_build_my_MSVC_application_with_a_static_runtime.3F
 #
-MACRO(specify_static_crt_flag)
+
+MACRO(swap_c_cxx_flag FROM TO)
   SET(vars
     CMAKE_C_FLAGS
     CMAKE_C_FLAGS_DEBUG
@@ -343,8 +344,8 @@ MACRO(specify_static_crt_flag)
     CMAKE_CXX_FLAGS_RELWITHDEBINFO)
 
   FOREACH(flag_var ${vars})
-    IF(${flag_var} MATCHES "/MD")
-      STRING(REGEX REPLACE "/MD" "/MT" ${flag_var} "${${flag_var}}")
+    IF(${flag_var} MATCHES ${FROM})
+      STRING(REGEX REPLACE ${FROM} ${TO} ${flag_var} "${${flag_var}}")
     ENDIF()
   ENDFOREACH()
 
@@ -354,13 +355,29 @@ MACRO(specify_static_crt_flag)
   MESSAGE(STATUS "")
 ENDMACRO()
 
-# Option to use Static Runtimes in MSVC
+MACRO(specify_static_crt_flag)
+  swap_c_cxx_flag("/MDd" "/MTd")
+  swap_c_cxx_flag("/MD" "/MT")
+ENDMACRO()
+
+MACRO(specify_release_crt_flag)
+  swap_c_cxx_flag("/MDd" "/MD")
+  swap_c_cxx_flag("/MTd" "/MT")
+ENDMACRO()
+
+# Option to use Release (non-Debug) Runtimes in MSVC (only relvant
+# to the 'Debug' configuration.
 IF(MSVC)
   OPTION(NC_USE_STATIC_CRT "Use static CRT Libraries ('\\MT')." OFF)
   IF(NC_USE_STATIC_CRT)
     SET(USE_STATIC_CRT ON)
     specify_static_crt_flag()
   ENDIF()
+  OPTION(NC_USE_RELEASE_CRT "Force use of release CRT Libraries (even for Debug) ('\\MD')." OFF)
+  IF(NC_USE_RELEASE_CRT)
+    SET(USE_RELEASE_CRT ON)
+    specify_release_crt_flag()
+  ENDIF()
 ENDIF()
 
 # Option to build netCDF Version 2
-- 
2.15.0

